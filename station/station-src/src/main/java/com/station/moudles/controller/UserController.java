package com.station.moudles.controller;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.google.common.collect.Maps;
import com.station.common.Constant;
import com.station.moudles.entity.Roles;
import com.station.moudles.entity.User;
import com.station.moudles.entity.UserRole;
import com.station.moudles.service.RolesService;
import com.station.moudles.service.UserRoleService;
import com.station.moudles.service.UserService;
import com.station.moudles.vo.AjaxResponse;
import com.station.moudles.vo.ShowPage;
import com.station.moudles.vo.search.SearchUserPagingVo;

import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;

/**
 * This class was generated by Bill Generator. This class corresponds to the
 * database table users
 *
 * @zdmgenerated 2017-47-19 10:47
 */
@Controller
@RequestMapping(value = "/user")
public class UserController extends BaseController {
	@Autowired
	UserService userSer;
	@Autowired
	RolesService rolesSer;
	@Autowired
	UserRoleService userRoleSer;

	@RequestMapping(value = "/list", method = RequestMethod.POST)
	@ResponseBody
	@ApiOperation(value = "根据条件获取列表", notes = "返回列表")
	public AjaxResponse<List<User>> getUserList(@RequestBody User queryUser) {
		List<User> userList = userSer.selectListSelective(queryUser);
		AjaxResponse<List<User>> ajaxResponse = new AjaxResponse<List<User>>(userList);
		return ajaxResponse;
	}

	@RequestMapping(value = "/listPage", method = RequestMethod.POST)
	@ResponseBody
	@ApiOperation(value = "根据条件获取列表分页", notes = "返回列表分页")
	public AjaxResponse<ShowPage<User>> getUserListPage(@RequestBody SearchUserPagingVo searchUserPagingVo) {

		List<User> userList = userSer.selectListSelectivePaging(searchUserPagingVo);
		List<User> newUserList = new ArrayList<User>();
		for (User user : userList) {
			if(user.getRoleId() != null) {
				Roles role = rolesSer.selectByPrimaryKey(user.getRoleId());
				if(role != null) {
				User newUser = new User();
				BeanUtils.copyProperties(user,newUser);
				newUser.setRoleName(role.getRoleName());
				newUserList.add(newUser);
				continue;
				}
			}
			newUserList.add(user);
		}	
		ShowPage<User> page = new ShowPage<User>(searchUserPagingVo, newUserList);
		AjaxResponse<ShowPage<User>> ajaxResponse = new AjaxResponse<ShowPage<User>>(page);
		return ajaxResponse;
	}

	@RequestMapping(value = "/save", method = RequestMethod.POST)
	@ResponseBody
	@ApiOperation(value = "新增", notes = "新增")
	@ApiImplicitParams(value = { @ApiImplicitParam(required = false, name = "userId", paramType = "query") })
	public AjaxResponse<User> save(@RequestBody User user) {
		user.setUserId(null);
		AjaxResponse<User> ajaxResponse = new AjaxResponse<User>(Constant.RS_CODE_ERROR, "修改出错！");
		request.setAttribute(Constant.ERROR_REQUEST, ajaxResponse);
		try {
			userSer.insertSelective(user);
			List<User> latestUserList = userSer.selectListSelective(user);
			User latestUser = latestUserList.stream().max(Comparator.comparing(User::getUserId)).get();
			if(latestUser.getRoleId() != null) {
				UserRole userRole = new UserRole();
				userRole.setRoleId(latestUser.getRoleId());
				userRole.setUserId(latestUser.getUserId());
				userRoleSer.insertSelective(userRole);
			}
			ajaxResponse.setCode(Constant.RS_CODE_SUCCESS);
			ajaxResponse.setMsg("添加成功！");
		} catch (Exception e) {
			ajaxResponse.setMsg("用户已存在！");
			e.printStackTrace();
		}
		return ajaxResponse;
	}

	@RequestMapping(value = "/update", method = RequestMethod.POST)
	@ResponseBody
	@ApiOperation(value = "根据pk更新", notes = "根据pk更新，属性为null的不更新")
	public AjaxResponse<Object> update(@RequestBody User user) {
		if (user.getUserId() == null) {
			return new AjaxResponse<Object>(Constant.RS_CODE_ERROR, "请设置pk！");
		}
		AjaxResponse<Object> ajaxResponse = new AjaxResponse<Object>(Constant.RS_CODE_ERROR, "修改出错！");
		request.setAttribute(Constant.ERROR_REQUEST, ajaxResponse);
		try {
			// 按照一个用户只有一个角色做的。因为web页面，设计的是一个用户只有一个角色
			if (user.getRoleId() != null) {
				UserRole queryUserRole = new UserRole();
				queryUserRole.setUserId(user.getUserId());
				List<UserRole> userRoleList = userRoleSer.selectListSelective(queryUserRole);
				if (userRoleList != null && userRoleList.size() > 0) {
					UserRole userRole = userRoleList.get(0);
					userRole.setRoleId(user.getRoleId());
					userRoleSer.updateByPrimaryKeySelective(userRole);
				} else {
					UserRole userRole = new UserRole();
					userRole.setRoleId(user.getRoleId());
					userRole.setUserId(user.getUserId());
					userRoleSer.insertSelective(userRole);
				}
			}
			userSer.updateByPrimaryKeySelective(user);
			ajaxResponse.setCode(Constant.RS_CODE_SUCCESS);
			ajaxResponse.setMsg("修改成功！");
		} catch (Exception e) {
			ajaxResponse.setMsg("用户已存在！");
			e.printStackTrace();
		}
		return ajaxResponse;
	}

	@RequestMapping(value = "/entity/{userId}", method = RequestMethod.POST)
	@ResponseBody
	@ApiOperation(value = "根据pk获取", notes = "根据pk获取")
	public AjaxResponse<User> getEntity(@PathVariable Integer userId) {
		AjaxResponse<User> ajaxResponse = new AjaxResponse<User>(Constant.RS_CODE_SUCCESS, "获取成功！");
		if (userId == null) {
			return new AjaxResponse<User>(Constant.RS_CODE_ERROR, "请选择pk！");
		}
		User user = userSer.selectByPrimaryKey(userId);
		if (user != null) {
			// UserDetail userDetail = new UserDetail();
			List<Roles> rolesList = rolesSer.selectListByUserId(userId);
			// BeanUtils.copyProperties(user, userDetail);
			// userDetail.setRolesList(rolesList);
			if (rolesList != null && rolesList.size() > 0) {
				user.setRoleId(rolesList.get(0).getRoleId());
			}else {
				user.setRoleId(null);
			}
			ajaxResponse.setData(user);
		} else {
			ajaxResponse.setCode(Constant.RS_CODE_ERROR);
			ajaxResponse.setMsg("获取失败！");
		}
		return ajaxResponse;
	}
}